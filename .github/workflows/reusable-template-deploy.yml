name: Reusable - Deploy Template

on:
  workflow_call:
    inputs:
      template_dir:
        description: 'Template directory (e.g., templates/minimal)'
        required: true
        type: string
      project_name:
        description: 'Cloudflare Pages project name'
        required: true
        type: string
      deploy_subdir:
        description: 'Subdirectory to deploy (default: dist)'
        default: 'dist'
        required: false
        type: string

jobs:
  deploy:
    name: Deploy ${{ inputs.template_dir }}
    runs-on: ubuntu-latest
    concurrency:
      group: templates-${{ inputs.project_name }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Download library artifact
        uses: actions/download-artifact@v4
        with:
          name: vuesip-dist
          path: dist/

      - name: Install template dependencies
        working-directory: ${{ inputs.template_dir }}
        run: |
          sed -i 's/"vuesip": "workspace:\*"/"vuesip": "file:..\/..\/dist"/' package.json
          pnpm install --no-frozen-lockfile

      - name: Build template
        working-directory: ${{ inputs.template_dir }}
        run: pnpm run build

      - name: Create Pages project (if not exists)
        working-directory: ${{ inputs.template_dir }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          pnpm exec wrangler pages project create ${{ inputs.project_name }} --production-branch=main || true

      - name: Deploy to Cloudflare Pages (with retry)
        uses: nick-fields/retry@v3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 20
          command: >-
            cd ${{ inputs.template_dir }} && pnpm exec wrangler pages deploy
            ${{ inputs.deploy_subdir }}
            --project-name=${{ inputs.project_name }}
            --branch=main
            --commit-dirty=true

