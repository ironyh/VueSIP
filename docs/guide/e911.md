# E911 Emergency Call Handling

VueSIP’s E911 support helps you meet **Kari’s Law** and **RAY BAUM’s Act** by detecting emergency calls, managing dispatchable locations, notifying on-site personnel, and keeping compliance logs. Use the `useSipE911` composable for the main flow; reuse helpers from `@/utils/e911` when you need sanitization, validation, or formatting in tests or custom flows.

## When to use useSipE911

- You need to **detect** emergency calls (e.g. 911) and optionally test numbers (e.g. 933).
- You must provide **dispatchable location** (civic and/or geo) for emergency services.
- You want **on-site notifications** (email/SMS/webhook) when an emergency call is placed.
- You need **compliance logging** and export for audits.

## Setup

Pass a ref to your SIP client and the app’s event bus. Optionally pass initial config and callbacks:

```ts
import { useSipClient, useSipE911 } from 'vuesip'
import { computed } from 'vue'

const { getClient, getEventBus } = useSipClient()
const client = computed(() => getClient())
const eventBus = getEventBus()

const e911 = useSipE911(client, eventBus, {
  config: {
    defaultCallbackNumber: '+15551234567',
    onSiteNotification: true,
    dispatchableLocationRequired: true,
  },
  autoStart: false,
  onEmergencyCall: (call) => console.log('Emergency call:', call.callerExtension),
  onNotificationSent: (n) => console.log('Notified:', n.recipient.name),
  onError: (err) => console.error('E911 error:', err),
})
```

## Monitoring

- **Start/stop:** `e911.startMonitoring()` and `e911.stopMonitoring()`. Check `e911.isMonitoring`.
- **Active calls:** `e911.activeCalls` (Map), `e911.activeCallList` (array), `e911.hasActiveEmergency`.
- **History:** `e911.callHistory`, `e911.getCallsInRange(from, to)`, `e911.getCall(callId)`.

## Locations

- **Add:** `e911.addLocation({ name, type: 'civic'|'geodetic', civic: {...}, extensions: ['1001'], isDefault, isVerified })`.
- **Update/remove:** `e911.updateLocation(locationId, updates)`, `e911.removeLocation(locationId)`.
- **Lookup:** `e911.getLocation(locationId)`, `e911.getLocationForExtension(ext)`.
- **Default:** `e911.setDefaultLocation(locationId)`. Read `e911.defaultLocation`, `e911.locationList`.

Use **civic** (street, city, state, postal, country) and/or **geo** (lat/lon) so that emergency services get a dispatchable location.

## Notifications (recipients)

- **Add recipients:** `e911.addRecipient({ name, email, phone, type: 'email'|'sms'|'webhook', ... })`.
- **Update/remove:** `e911.updateRecipient(id, updates)`, `e911.removeRecipient(id)`.
- **Test:** `e911.sendTestNotification()` (uses current config and recipients).

Recipients are used for on-site notification when an emergency call is detected; configure them in `e911.config` (or via `e911.updateConfig`) and through the recipient CRUD above.

## Compliance

- **Logs:** `e911.complianceLogs`, `e911.getLogs()`, `e911.exportLogs()`.
- **Check:** `e911.checkCompliance()` to validate config/locations/recipients.
- **Cleanup:** `e911.clearOldLogs(olderThanMs)` to prune old entries.

Enable `config.complianceLogging` and use the same composable instance so all events are recorded.

## Helpers in `@/utils/e911`

For custom E911 logic or tests, import from `@/utils/e911` (or `vuesip/utils`):

- **Sanitization:** `sanitizeInput`, `sanitizeEmail`, `sanitizePhone`, `sanitizeUrl`
- **Validation:** `isValidExtension(ext)`
- **Formatting:** `formatE911Location(location)` for display
- **Defaults:** `createDefaultE911Config()`, `createEmptyE911Stats()`
- **IDs:** `generateE911Id()`

See [API – Utilities](/api/utilities#e911-helpers) for full signatures.

## Internal architecture

`useSipE911` is the public API and orchestrates three internal composables (not part of the public API):

- **useE911Locations** – Location state and CRUD (add/update/remove/setDefault, getLocation, getLocationForExtension). No logging; `useSipE911` adds compliance logs when locations change.
- **useE911Recipients** – Notification recipient state and CRUD (add/update/remove). Recipients are synced into `config.recipients`; `useSipE911` adds logs for recipient changes.
- **useE911Compliance** – Compliance log storage, `addLog`, `getLogs`, `exportLogs`, and `clearOldLogs`. Respects `config.complianceLogging`; `useSipE911` calls `addLog` for all events.

Event handling, monitoring lifecycle, notifications, and `checkCompliance` remain in `useSipE911`. This split keeps each composable focused and makes refactors and tests easier.

## See also

- [API – useSipE911](/api/composables#usesipe911) for the full composable API.
- [API – E911 utilities](/api/utilities#e911-helpers) for `@/utils/e911` functions.
- Playground: `playground/demos/E911Demo.vue` for a working example.
